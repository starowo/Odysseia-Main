# 🚀 Odysseia Discord Bot 部署指南

---

##  前置准备


### 1. 软件环境
- ✅ **Python 3.10+** 已安装
- ✅ **Git** 已安装（可选，用于更新）
- ✅ **文本编辑器** （推荐 VS Code 或 Notepad++）

### 2. Discord准备
- ✅ Discord账号
- ✅ 测试服务器（强烈推荐新建一个用于测试）
- ✅ 管理员权限

---

## 🤖 第一步：创建Discord机器人

### 1.1 访问discord dev平台
1. 前往：https://discord.com/developers/applications
2. 使用Discord账号登录

### 1.2 创建应用程序
1. 点击右上角 `New Application`
2. 输入名称：`您喜欢的bot名称` 
3. 点击 `Create`

### 1.3 创建机器人
1. 左侧菜单点击 `Bot`
2. 点击 `Add Bot` → `Yes, do it!`
3. 设置机器人名称和头像
4. **可选**: 设置机器人描述

### 1.4 配置重要权限 ⚠️
**必须启用以下选项，否则机器人无法正常工作**：
- ✅ `MESSAGE CONTENT INTENT`
- ✅ `SERVER MEMBERS INTENT` 
- ✅ `PRESENCE INTENT`

### 1.5 获取Token
1. 在Token部分点击 `Copy` 
2. **⚠️ 重要**: 妥善保管Token，绝不要在任何地方泄露
3. 建议将Token保存到安全的密码管理器中

---

## 🔗 第二步：邀请机器人到服务器

### 2.1 生成邀请链接
1. 左侧菜单：`OAuth2` → `URL Generator`
2. **Scopes** 选择：
   - ✅ `bot`
   - ✅ `applications.commands`
3. **Bot Permissions** 选择：
   - ✅ `Administrator` （推荐，一键配置所有权限）
   
### 2.2 邀请到服务器
1. 复制生成的URL链接
2. 在浏览器中打开链接
3. 选择目标服务器
4. 确认权限并点击授权

---

## 🔧 第三步：下载并配置机器人

### 3.1 下载项目
**方法一：Git克隆**（推荐）
```bash
git clone <项目地址>
cd Odysseia-Main
```

**方法二：下载ZIP**
1. 下载项目ZIP文件
2. 解压到合适的目录
3. 进入 `Odysseia-Main` 文件夹

### 3.2 安装依赖
```bash
pip install -r requirements.txt
```

如果遇到权限问题，使用：
```bash
pip install -r requirements.txt --user
```

### 3.3 创建配置文件
复制配置示例文件：
```bash
cp config.example.json config.json
```

如果没有示例文件，手动创建 `config.json`

---

## ⚙️ 第四步：配置机器人

### 4.1 基础配置结构
创建 `config.json` 文件，包含以下基础结构：

```json
{
    "token": "你的机器人Token",
    "prefix": "!",
    "status": "watching",
    "status_text": "服务器管理中",
    "admins": [管理员用户ID列表], // 全局管理员用户ID
    
    "cogs": {
        "thread_manage": {"enabled": true},
        "admin": {"enabled": true},
        "anonymous_feedback": {"enabled": true},
        "verify": {"enabled": true},
        "misc": {"enabled": true},
        "event": {"enabled": true}
    },
    
    "guild_configs": {
        "你的服务器ID": { // 服务器ID应为字符串
            "name": "服务器名称",
            "admins": [服务器管理员身份组ID列表], // 特定服务器的管理员身份组ID列表（不是用户ID）
            "verified_role_id": 验证身份组ID, // 数字ID
            "buffer_role_id": 缓冲身份组ID, // 数字ID
            "quiz_role_id": 答题身份组ID, // 数字ID
            "warned_role_id": 警告身份组ID, // 数字ID
            "punish_announce_channel_id": 处罚公示频道ID, // 数字ID
            "logging": {
                "enabled": true,
                "channel_id": 日志频道ID, // 数字ID
                "level": "INFO"
            }
            // 匿名反馈系统为自动化功能，无需额外配置
        }
    }
}
```

**重要提示：**
- 全局 `admins` 应填写用户的Discord ID，用于跨服务器的最高权限管理员。
- 各服务器 `guild_configs` 内的 `admins` 应填写身份组ID，用于该服务器的管理员权限检查。
- 所有频道ID和身份组ID都应该是数字格式。

### 4.2 获取必要的ID信息

#### 启用开发者模式
1. Discord设置 → 高级 → 开发者模式（开启）

#### 获取各种ID
- **服务器ID**: 右键服务器名称 → 复制服务器ID
- **用户ID**: 右键自己头像 → 复制用户ID  
- **频道ID**: 右键频道名称 → 复制频道ID
- **角色ID**: 服务器设置 → 角色 → 右键角色 → 复制角色ID

### 4.3 创建必要的身份组和频道

#### 必需身份组
在服务器设置中创建以下身份组：
1. **已验证** - 给通过验证的用户
2. **验证缓冲** - 验证过程中的临时身份组  
3. **答题验证** - 需要重新答题的用户
4. **警告状态** - 被警告的用户
5. **管理员** - 服务器管理员身份组（填入admins配置中）

#### 必需频道
建议创建以下频道：
1. **机器人日志** - 记录机器人运行日志
2. **处罚公示** - 公示封禁/警告等处罚
3. **验证频道** - 用户验证入口

---

## 🚀 第五步：启动机器人

### 5.1 首次启动
在项目目录中执行：
```bash
python main.py
```

### 5.2 验证启动状态
成功启动后应显示：
- ✅ 配置文件加载成功
- ✅ 各功能模块加载状态
- ✅ 连接Discord成功
- ✅ 机器人上线通知

### 5.3 常见启动问题
**Token错误**：
```
discord.errors.LoginFailure
```
解决：检查config.json中的token是否正确

**权限错误**：
```
discord.errors.Forbidden
```
解决：确保机器人有足够权限，重新邀请并授予管理员权限

**模块加载失败**：
```
ImportError or ModuleNotFoundError
```
解决：重新安装依赖 `pip install -r requirements.txt`

---

## 🎯 第六步：功能测试

### 6.1 基础命令测试
测试以下命令确保功能正常：

1. **管理功能**
   - `/管理 身份组` - 测试身份组管理
   - `/管理 禁言` - 测试禁言功能
   - `/管理 永封` - 测试封禁功能

2. **匿名反馈** 🆕 (自动化系统)
   - `/匿名反馈 消息` - 在论坛帖子中测试匿名消息
   - `/匿名反馈 图片` - 在论坛帖子中测试匿名图片
   - `/匿名反馈 文件` - 在论坛帖子中测试匿名文件

3. **子区管理** 🔧
   - `/自助管理 清理子区` - 在论坛帖中测试
   - `/自助管理 锁定子区` - 测试子区锁定
   - `/自助管理 删帖` - 测试删除功能

4. **验证系统**
   - 检查验证频道按钮是否出现
   - 测试完整验证流程

5. **赛事管理**
   - `/赛事 自助身份组发放` - 测试身份组自助获取
   - `/赛事 检查发帖` - 测试发帖检查功能

### 6.2 权限验证
- ✅ 管理员可以使用所有管理命令
- ✅ 普通用户只能使用基础功能
- ✅ 帖主可以管理自己的帖子
- ✅ 非帖主无法使用帖主专属功能

---

## 🆕 匿名反馈系统详解

本机器人的匿名反馈系统是**自动化的论坛专用功能**，专门设计用于论坛类频道的帖子讨论。

### 功能特点
- **论坛专用**: 只能在论坛类频道(Forum Channel)的帖子内使用
- **完全自动化**: 无需任何配置，开箱即用
- **完全匿名**: 通过加密cookie系统确保用户身份不可追踪
- **多媒体支持**: 支持匿名发送文字、图片、文件
- **智能管理**: 内置反垃圾和举报机制
- **数据隔离**: 每个服务器的匿名数据完全独立

### 使用说明
匿名反馈系统**不需要任何配置**，只要在`config.json`中启用了`anonymous_feedback`模块即可使用：

```json
"cogs": {
    "anonymous_feedback": {"enabled": true}
}
```

### 使用流程
1. 用户在论坛帖子内可使用三种匿名反馈命令（消息/图片/文件）
2. 系统自动生成加密的匿名身份标识
3. 匿名消息直接发送到当前帖子中
4. 其他用户看到的是完全匿名的消息
5. 支持其他用户对匿名消息进行举报和管理（点10个踩可以删除消息并警告发送者），三次警告封禁该用户在对应帖主的任意帖子下使用匿名消息的功能
6. 帖主可根据反馈编号溯源恶意用户并进行封禁（三次警告制，可叠加），管理员只能进行封禁不能溯源。但帖主的溯源操作会被记录在log中，请勿滥用。

### 可用命令
- `/匿名反馈 消息 [内容]` - 发送匿名文字消息
- `/匿名反馈 图片` - 发送匿名图片（会提示上传）
- `/匿名反馈 文件` - 发送匿名文件（会提示上传）

### 管理功能
- 管理员可以删除匿名消息
- 支持用户举报不当匿名内容
- 内置反垃圾信息机制
- 自动记录违规行为日志

---

## 🔧 故障排除指南

### 启动问题

#### 1. Python版本不兼容
**症状**: `SyntaxError` 或版本警告
**解决**: 升级到Python 3.10+
```bash
python --version
```

#### 2. 依赖包缺失
**症状**: `ModuleNotFoundError`
**解决**: 重新安装依赖
```bash
pip install -r requirements.txt --upgrade
```

#### 3. 配置文件错误
**症状**: `JSONDecodeError` 或配置加载失败
**解决**: 
1. 检查config.json语法
2. 使用JSON验证器验证格式
3. 确保所有ID为数字类型 (服务器ID在guild_configs的键中是字符串，但其内部引用的ID值是数字)

### 功能问题

#### 1. 斜杠命令不显示
**原因**: 应用命令同步问题
**解决**: 
1. 重启机器人
2. 等待5-10分钟让Discord同步
3. 确保机器人有`applications.commands`权限

#### 2. 权限不足错误
**原因**: 机器人权限配置不当
**解决**:
1. 重新邀请机器人并授予管理员权限
2. 检查角色权限层级
3. 确保机器人角色在目标角色之上

#### 3. 某些功能无响应
**原因**: 模块未启用或配置错误
**解决**:
1. 检查config.json中对应模块是否enabled: true
2. 验证相关频道和角色ID是否正确
3. 查看日志频道的错误信息

#### 4. 匿名反馈无法使用
**原因**: 可能不在论坛频道或模块未启用
**解决**:
1. 确保在论坛类频道的帖子内使用
2. 检查anonymous_feedback模块是否启用
3. 确认机器人有该频道的发送消息权限

---

## 🔄 更新维护

### 定期备份
重要文件：
- `config.json` - 配置文件
- `data/` 目录 - 用户数据 (如果存在)
- `logs/` 目录 - 日志文件

### 更新流程
1. **备份现有配置和数据**
2. **下载新版本代码**
3. **对比配置文件变更** (查看 `config.example.json` 的改动)
4. **测试新功能**
5. **正式部署**

### 监控指标
- 机器人在线时间
- 命令执行成功率
- 错误日志频率
- 用户活跃度

---

## 🎉 部署完成

恭喜！您已成功部署Odysseia Discord机器人。

### 技术支持
- 🐛 GitHub Issues反馈问题  
