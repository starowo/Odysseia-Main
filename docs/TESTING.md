# Discordæœºå™¨äººé¡¹ç›®æµ‹è¯•æŒ‡å—

## æ¦‚è¿°

æœ¬é¡¹ç›®åŒ…å«ä¸€ä¸ªå®Œæ•´çš„è‡ªåŠ¨åŒ–æµ‹è¯•ç³»ç»Ÿï¼Œç”¨äºéªŒè¯Discordæœºå™¨äººçš„åŠŸèƒ½å’Œä»£ç è´¨é‡ã€‚æµ‹è¯•ç³»ç»Ÿè®¾è®¡ä¸ºå¯æ‰©å±•çš„ï¼Œä¾¿äºåç»­æ·»åŠ æ›´å¤šæµ‹è¯•ã€‚

## æµ‹è¯•ç»“æ„

```
tests/
â”œâ”€â”€ __init__.py              # æµ‹è¯•åŒ…åˆå§‹åŒ–
â”œâ”€â”€ conftest.py              # pytesté…ç½®å’Œå¤¹å…·
â”œâ”€â”€ test_code_quality.py     # ä»£ç è´¨é‡æ£€æŸ¥
â”œâ”€â”€ test_hot_reload.py       # çƒ­é‡è½½åŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ test_cogs.py            # CogåŠŸèƒ½æµ‹è¯•
â””â”€â”€ test_config_system.py   # é…ç½®ç³»ç»Ÿæµ‹è¯•
```

## å®‰è£…æµ‹è¯•ä¾èµ–

```bash
pip install -r requirements-test.txt
```

## è¿è¡Œæµ‹è¯•

### ä½¿ç”¨æµ‹è¯•è¿è¡Œå™¨ï¼ˆæ¨èï¼‰

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python run_tests.py all

# è¿è¡Œç‰¹å®šç±»å‹çš„æµ‹è¯•
python run_tests.py quality    # ä»£ç è´¨é‡æ£€æŸ¥
python run_tests.py reload     # çƒ­é‡è½½æµ‹è¯•
python run_tests.py cogs       # CogåŠŸèƒ½æµ‹è¯•
python run_tests.py config     # é…ç½®ç³»ç»Ÿæµ‹è¯•

# æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
python run_tests.py all -v
```

### ä½¿ç”¨pytestç›´æ¥è¿è¡Œ

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pytest tests/test_hot_reload.py

# è¿è¡Œç‰¹å®šæµ‹è¯•ç±»
pytest tests/test_cogs.py::TestCogSetupFunctions

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
pytest tests/test_hot_reload.py::TestHotReload::test_load_extension_success

# æ˜¾ç¤ºè¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=src --cov=main --cov-report=html
```
### ä½¿ç”¨Makefileè¿è¡Œ
```bash
make test           # è¿è¡Œæ‰€æœ‰æµ‹è¯•
make test-quality   # ä»£ç è´¨é‡æ£€æŸ¥
make coverage       # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
make lint           # ä»£ç æ£€æŸ¥
make format         # ä»£ç æ ¼å¼åŒ–
```


## æµ‹è¯•ç±»å‹è¯´æ˜

### 1. ä»£ç è´¨é‡æ£€æŸ¥ (`test_code_quality.py`)

- **è¯­æ³•æ£€æŸ¥**: éªŒè¯æ‰€æœ‰Pythonæ–‡ä»¶çš„è¯­æ³•æ­£ç¡®æ€§
- **å¯¼å…¥ä¾èµ–æ£€æŸ¥**: ç¡®ä¿æ‰€æœ‰å¯¼å…¥è¯­å¥éƒ½èƒ½æ­£ç¡®è§£æ
- **å¿…éœ€å‡½æ•°æ£€æŸ¥**: éªŒè¯å…³é”®å‡½æ•°ï¼ˆå¦‚setupå‡½æ•°ï¼‰æ˜¯å¦å­˜åœ¨
- **Cogç±»æ£€æŸ¥**: ç¡®ä¿æ‰€æœ‰Cogç±»éƒ½æ­£ç¡®å®šä¹‰

### 2. çƒ­é‡è½½åŠŸèƒ½æµ‹è¯• (`test_hot_reload.py`)

- **CogManageråˆå§‹åŒ–**: æµ‹è¯•æ–°çš„CogManagerç±»æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–
- **æ‰©å±•åŠ è½½**: æµ‹è¯•`load_extension`æ–¹æ³•çš„å„ç§æƒ…å†µ
- **æ‰©å±•å¸è½½**: æµ‹è¯•`unload_extension`æ–¹æ³•çš„å„ç§æƒ…å†µ
- **æ‰©å±•é‡è½½**: æµ‹è¯•`reload_extension`æ–¹æ³•çš„å„ç§æƒ…å†µ
- **æ‰¹é‡åŠ è½½**: æµ‹è¯•`load_all_enabled`æ–¹æ³•

### 3. CogåŠŸèƒ½æµ‹è¯• (`test_cogs.py`)

- **setupå‡½æ•°æµ‹è¯•**: éªŒè¯æ‰€æœ‰Cogçš„setupå‡½æ•°éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- **Cogåˆå§‹åŒ–æµ‹è¯•**: æµ‹è¯•Cogç±»çš„åˆå§‹åŒ–è¿‡ç¨‹
- **æƒé™æ£€æŸ¥æµ‹è¯•**: æµ‹è¯•interaction_checkæ–¹æ³•çš„æƒé™éªŒè¯

### 4. é…ç½®ç³»ç»Ÿæµ‹è¯• (`test_config_system.py`)

- **é…ç½®åŠ è½½**: æµ‹è¯•é…ç½®æ–‡ä»¶çš„åŠ è½½å’Œé”™è¯¯å¤„ç†
- **é…ç½®ä¼ é€’**: éªŒè¯é…ç½®åœ¨botå’ŒCogä¹‹é—´çš„ä¼ é€’æœºåˆ¶
- **é…ç½®æ›´æ–°**: æµ‹è¯•é…ç½®æ›´æ–°æœºåˆ¶
- **æ¨¡å—è·¯å¾„é…ç½®**: éªŒè¯æ¨¡å—è·¯å¾„æ˜ å°„çš„æ­£ç¡®æ€§

## æµ‹è¯•å¤¹å…·è¯´æ˜

### ä¸»è¦å¤¹å…· (`conftest.py`)

- `mock_config`: æä¾›æ¨¡æ‹Ÿçš„é…ç½®æ•°æ®
- `temp_config_file`: åˆ›å»ºä¸´æ—¶é…ç½®æ–‡ä»¶ç”¨äºæµ‹è¯•
- `mock_bot`: æ¨¡æ‹Ÿçš„Discordæœºå™¨äººå®ä¾‹
- `mock_interaction`: æ¨¡æ‹Ÿçš„Discordäº¤äº’å®ä¾‹
- `mock_user`: æ¨¡æ‹Ÿçš„Discordç”¨æˆ·å®ä¾‹
- `mock_guild`: æ¨¡æ‹Ÿçš„DiscordæœåŠ¡å™¨å®ä¾‹

## æ·»åŠ æ–°æµ‹è¯•

### 1. åˆ›å»ºæ–°çš„æµ‹è¯•æ–‡ä»¶

```python
# tests/test_new_feature.py
import pytest
from unittest.mock import AsyncMock, MagicMock

class TestNewFeature:
    @pytest.fixture(autouse=True)
    def setup(self, mock_bot, mock_config):
        self.mock_bot = mock_bot
        self.mock_config = mock_config
    
    def test_new_functionality(self):
        # æµ‹è¯•ä»£ç 
        pass
    
    @pytest.mark.asyncio
    async def test_async_functionality(self):
        # å¼‚æ­¥æµ‹è¯•ä»£ç 
        pass
```

### 2. æ›´æ–°æµ‹è¯•è¿è¡Œå™¨

åœ¨`run_tests.py`ä¸­æ·»åŠ æ–°çš„æµ‹è¯•æ–¹æ³•ï¼š

```python
def run_new_feature_tests(self, verbose=False):
    """è¿è¡Œæ–°åŠŸèƒ½æµ‹è¯•"""
    print("ğŸ†• è¿è¡Œæ–°åŠŸèƒ½æµ‹è¯•...")
    
    cmd = [
        sys.executable, "-m", "pytest",
        str(self.test_dir / "test_new_feature.py"),
        "-v" if verbose else "-q"
    ]
    
    result = subprocess.run(cmd, capture_output=True, text=True)
    return result.returncode == 0
```

## æŒç»­é›†æˆ

é¡¹ç›®åŒ…å«GitHub Actionså·¥ä½œæµé…ç½®ï¼ˆ`.github/workflows/tests.yml`ï¼‰ï¼Œä¼šåœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨è¿è¡Œæµ‹è¯•ï¼š

- æ¨é€åˆ°mainæˆ–developåˆ†æ”¯
- åˆ›å»ºPull Requeståˆ°mainåˆ†æ”¯

## æµ‹è¯•æŠ¥å‘Š

æµ‹è¯•è¿è¡Œåä¼šç”Ÿæˆä»¥ä¸‹æŠ¥å‘Šï¼š

- **æ§åˆ¶å°è¾“å‡º**: å®æ—¶æ˜¾ç¤ºæµ‹è¯•ç»“æœ
- **JSONæŠ¥å‘Š**: `test_report.json` - åŒ…å«è¯¦ç»†çš„æµ‹è¯•ç»“æœæ•°æ®
- **è¦†ç›–ç‡æŠ¥å‘Š**: `htmlcov/index.html` - HTMLæ ¼å¼çš„ä»£ç è¦†ç›–ç‡æŠ¥å‘Š

## æœ€ä½³å®è·µ

1. **ç¼–å†™æµ‹è¯•å‰å…ˆè¿è¡Œç°æœ‰æµ‹è¯•**: ç¡®ä¿åŸºç¡€åŠŸèƒ½æ­£å¸¸
2. **ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°**: æµ‹è¯•åç§°åº”è¯¥æ¸…æ¥šåœ°è¯´æ˜æµ‹è¯•çš„å†…å®¹
3. **ä¿æŒæµ‹è¯•ç‹¬ç«‹**: æ¯ä¸ªæµ‹è¯•åº”è¯¥èƒ½å¤Ÿç‹¬ç«‹è¿è¡Œ
4. **ä½¿ç”¨é€‚å½“çš„æ–­è¨€**: é€‰æ‹©æœ€åˆé€‚çš„æ–­è¨€æ–¹æ³•
5. **æ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ–**: ä½¿ç”¨mockå¯¹è±¡æ¨¡æ‹ŸDiscord APIç­‰å¤–éƒ¨ä¾èµ–
6. **æµ‹è¯•è¾¹ç•Œæƒ…å†µ**: ä¸ä»…æµ‹è¯•æ­£å¸¸æƒ…å†µï¼Œä¹Ÿè¦æµ‹è¯•é”™è¯¯æƒ…å†µ

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å¯¼å…¥é”™è¯¯**: ç¡®ä¿é¡¹ç›®æ ¹ç›®å½•åœ¨Pythonè·¯å¾„ä¸­
2. **å¼‚æ­¥æµ‹è¯•å¤±è´¥**: ç¡®ä¿ä½¿ç”¨`@pytest.mark.asyncio`è£…é¥°å™¨
3. **é…ç½®æ–‡ä»¶é—®é¢˜**: æ£€æŸ¥ä¸´æ—¶é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®åˆ›å»º
4. **Mockå¯¹è±¡é—®é¢˜**: ç¡®ä¿mockå¯¹è±¡å…·æœ‰æ‰€éœ€çš„å±æ€§å’Œæ–¹æ³•

### è°ƒè¯•æŠ€å·§

```bash
# è¿è¡Œå•ä¸ªæµ‹è¯•å¹¶æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
pytest tests/test_hot_reload.py::TestHotReload::test_load_extension_success -v -s

# åœ¨æµ‹è¯•å¤±è´¥æ—¶è¿›å…¥è°ƒè¯•å™¨
pytest --pdb

# æ˜¾ç¤ºæµ‹è¯•è¦†ç›–ç‡çš„è¯¦ç»†ä¿¡æ¯
pytest --cov=src --cov-report=term-missing
```

## æ‰©å±•æµ‹è¯•ç³»ç»Ÿ

æµ‹è¯•ç³»ç»Ÿè®¾è®¡ä¸ºå¯æ‰©å±•çš„ï¼Œå¯ä»¥è½»æ¾æ·»åŠ æ–°çš„æµ‹è¯•ç±»å‹ï¼š

1. åœ¨`tests/`ç›®å½•ä¸‹åˆ›å»ºæ–°çš„æµ‹è¯•æ–‡ä»¶
2. åœ¨`run_tests.py`ä¸­æ·»åŠ ç›¸åº”çš„è¿è¡Œæ–¹æ³•
3. æ›´æ–°å‘½ä»¤è¡Œå‚æ•°è§£æå™¨
4. åœ¨`run_all_tests`æ–¹æ³•ä¸­åŒ…å«æ–°æµ‹è¯•

è¿™æ ·å¯ä»¥ç¡®ä¿æµ‹è¯•ç³»ç»Ÿéšç€é¡¹ç›®çš„å‘å±•è€Œä¸æ–­å®Œå–„ã€‚
