# 🚀 Odysseia Discord Bot

一个功能强大的 Discord 机器人，专为类脑服务器管理而设计。现支持同时进行多服务器隔离管理。

## 📋 项目简介

Odysseia Discord Bot 是基于原有机器人项目的增强版本，针对原版本的局限性进行了改进，增加了多项功能，适合需要管理多个Discord服务器和处理用户反馈的社区。但同时也具有更高的硬件配置需求。

## 🔄 相比原版本的改进

### 🆕 核心新增功能

#### 1. 匿名反馈系统
**设计理念**：避免用户在预设/卡区等帖子进行反馈是由于chat记录和log记录包含敏感信息而导致不愿意积极反馈的情况出现。
**改进方案**：
-  **论坛专用**：只在论坛频道的帖子下工作的匿名交流功能
-  **完全自动化**：无需任何配置，在论坛频道的帖子下即可使用
-  **帖主权限**：帖主可追踪和管理针对自己帖子的匿名反馈
-  **反垃圾系统**：👎反应监控、频率限制、三警告封禁机制
-  **管理员工具**：管理员可处理恶意反馈，但无法追踪
-  **SQLite数据库**：架构了一个SQLite数据库用于服务匿名反馈系统，保证该系统各种意义上的安全性

#### 2. 多服务器架构
**原版本**：只支持单服务器
**改进方案**：
-  **数据完全隔离**：每个服务器的数据独立存储，互不影响
-  **权限独立管理**：全局管理员用用户ID，服务器管理员用身份组ID
-  **配置灵活定制**：每个服务器可有不同的功能启用状态
-  **日志独立显示**：每个服务器有专属的日志频道

### 🔧 性能与安全优化

#### 理论上的性能提升 
**改进**：
-  **配置缓存系统**：智能缓存，减少文件读取开销
-  **线程安全机制**：确保并发访问的数据一致性
-  **批量日志处理**：避免API频率限制


### 🛠️ 用户体验改进

#### 部署体验
**方案**：
-  **一键快速部署**：`python 快速部署.py` 交互式配置
-  **配置验证器**：自动检查配置文件正确性
-  **服务器信息获取工具**：自动获取Discord服务器信息
-  **详细文档**：完整的部署和使用指南

### 修复一些issue
-  **/管理 频道管理 指令**：现在slowmode支持关闭慢速模式
-  **修复了原赛事系统的一个隐藏issue**：赛事身份组发放功能初始化时的 _load_views 方法中，当views.json文件不存在时，会将 self.views 初始化为字典 {}，但后续的 _add_view 方法尝试使用 self.views.append()，这需要 self.views 是一个列表。如果 data/event/views.json 已经存在且格式正确，则不会触发bug，但如果在空配置环境下初次开始此功能，会导致无法正常运行。
-  **现在管理员的处罚撤销指令可以撤销永baan处罚**：原代码中执行该逻辑时，会因为永ban用户不存在于服务器中导致逻辑失败。尽管discord服务器可以手动管理永ban列表，但还是选择修复了此issue。
-  **bot的/管理模块指令修复**：现在支持使用bot指令热处理模块功能的开关

##  完整功能列表

### 🔒 匿名反馈系统（论坛专用）
- `/匿名反馈 消息 [内容]` - 发送匿名文字反馈
- `/匿名反馈 图片 [图片] [说明]` - 发送匿名图片反馈
- `/匿名反馈 文件 [文件] [说明]` - 发送匿名文件反馈
- `/帖主-溯源反馈 [反馈ID]` - 帖主追溯反馈发送者
- `/帖主-封禁反馈用户 [反馈ID] [原因]` - 帖主封禁恶意用户
- `/帖主-减少警告 [用户] [次数]` - 帖主减少用户警告
- `/匿名反馈管理 封禁 [用户] [原因]` - 管理员封禁功能

###  子区管理功能
- `/自助管理 清理子区 [阈值]` - 自动清理不活跃成员
- `/自助管理 删除消息 [消息链接]` - 删除指定消息
- `/自助管理 删帖` - 删除整个子区
- `/自助管理 锁定子区 [原因]` - 锁定/解锁子区
- `/自助管理 慢速模式 [秒数]` - 设置发言间隔
- `/自助管理 标注 [操作] [消息链接]` - 标注/取消标注重要消息

###  管理员工具
- `/管理 禁言 [成员] [天数] [原因]` - 禁言成员（支持设置天数）
- `/管理 永封 [成员] [原因]` - 永久封禁成员
- `/管理 撤销处罚 [处罚ID] [原因]` - 撤销处罚
- `/答题处罚 [成员]` - 移除身份组送往答题区
- `/管理 批量转移身份组 [原身份组] [新身份组]` - 批量转移身份组
- `/管理 频道管理 [频道] [设置...]` - 修改频道设置
- `/管理 子区管理 [操作] [子区]` - 管理员直接操作所有子区

###  验证系统
- `/验证` - 启动答题验证流程
- 自定义题目和身份组分配
- 完整的验证流程管理

###  机器人管理
- `/bot管理 模块列表` - 查看功能模块状态
- `/bot管理 启用模块 [模块名]` / `/bot管理 禁用模块 [模块名]` - 动态管理功能
- `/bot管理 重载模块 [模块名]` - 热重载功能模块
- `/bot管理 ping` - 检查响应时间

###  赛事管理
- `/赛事 自助身份组发放` - 身份组自助获取
- `/赛事 检查发帖` - 身份组领取选手是否已发帖的资格检查

###  杂项功能
- `/ping` - 检查机器人响应时间
- `/获取频道列表` - 获取服务器频道信息
- `/获取身份组列表` - 获取服务器身份组信息

## 🚀 快速开始

### 一键部署（推荐新手）
```bash
# 1. 克隆项目
git clone <repository-url>
cd Odysseia-Main

# 2. 安装依赖
pip install -r requirements.txt

# 3. 快速配置（交互式配置向导）
python 快速部署.py

# 4. 验证配置
python config_validator.py

# 5. 启动机器人
python main.py
```

### 手动配置（推荐）
如果您需要更精细的配置控制，请参考 [部署指南.md](部署指南.md) 获取详细说明。

## 📁 项目结构
```
Odysseia-Main/
├── main.py                    # 主程序入口
├── config.json               # 配置文件
├── config.example.json       # 配置模板
├── requirements.txt          # Python依赖
├── 快速部署.py               # 🆕 快速部署脚本
├── config_validator.py       # 🆕 配置验证工具
├── get_new_server_info.py    # 🆕 服务器信息获取
├── check_permissions.py      # 🆕 权限检查工具
├── 部署指南.md               # 详细部署指南
├── src/                      # 源代码目录
│   ├── anonymous_feedback/   # 🆕 匿名反馈系统
│   ├── admin/               # 管理员功能
│   ├── bot_manage/          # 机器人管理
│   ├── thread_manage/       # 子区管理
│   ├── verify/              # 验证系统
│   ├── misc/                # 杂项功能
│   ├── event/               # 赛事功能
│   └── utils/               # 工具函数
├── data/                     # 数据存储
│   ├── event/               # 赛事数据
│   ├── punish/              # 处罚记录
│   ├── thread_cache/        # 子区缓存
│   └── verify/              # 验证数据
├── logs/                     # 日志文件
├── tests/                    # 测试文件
├── run_tests.py             # 测试运行器
└── pytest.ini              # 测试配置
```

## ⚙️ 配置文件说明

### 基础配置结构
```json
{
    "token": "你的机器人Token",
    "prefix": "!",
    "status": "watching",
    "status_text": "多服务器管理中",
    "admins": [全局管理员用户ID列表],
    
    "cogs": {
        "thread_manage": {"enabled": true},
        "admin": {"enabled": true},
        "anonymous_feedback": {"enabled": true},
        "verify": {"enabled": true},
        "misc": {"enabled": true},
        "event": {"enabled": true},
        "bot_manage": {"enabled": true}
    },
    
    "guild_configs": {
        "服务器ID": {
            "name": "服务器名称",
            "admins": [服务器管理员身份组ID列表],
            "verified_role_id": 验证身份组ID,
            "buffer_role_id": 缓冲身份组ID,
            "quiz_role_id": 答题身份组ID,
            "warned_role_id": 警告身份组ID,
            "punish_announce_channel_id": 处罚频道ID,
            "logging": {
                "enabled": true,
                "channel_id": 日志频道ID
            },
            "event_managers": [赛事管理员用户ID列表],
            "highest_role_available": 最高可管理身份组ID
        }
    }
}
```

### 重要配置说明
- **权限配置差异**：
  - 全局管理员 (`admins`)：使用**用户ID**
  - 服务器管理员 (`guild_configs[server_id].admins`)：使用**身份组ID**
- **匿名反馈系统**：完全自动化，只需启用模块，无需额外配置
- **验证系统**：题目和流程在代码中硬编码，只需配置身份组ID
- **赛事管理**：可选功能，如不使用可在cogs中禁用

详细配置说明请查看 `config.example.json` 文件。

##  多服务器部署

### 添加新服务器
1. **邀请机器人**：使用相同的邀请链接邀请到新服务器
2. **获取服务器信息**：
   ```bash
   python get_new_server_info.py
   ```
3. **添加配置**：在 `config.json` 的 `guild_configs` 中添加新服务器配置
4. **重启机器人**：重新启动以加载新配置

### 数据隔离特性
-  **独立的匿名反馈数据库**：每个服务器的反馈数据完全分离
-  **独立的日志系统**：每个服务器有专属日志频道
-  **独立的权限管理**：管理员权限严格按服务器隔离
-  **独立的匿名身份**：同一用户在不同服务器有不同匿名ID

## 🔧 实用工具

### 快速部署脚本
```bash
python 快速部署.py
```
交互式配置向导，适合零代码基础用户，包含：
-  机器人基础信息设置
-  全局管理员配置
-  多服务器配置
-  功能模块选择
-  自动配置验证和保存

### 配置验证器
```bash
python config_validator.py
```
自动检查配置文件的正确性，发现问题并提供修复建议。

### 服务器信息获取器
```bash
python get_new_server_info.py
```
自动获取Discord服务器的ID、频道ID、身份组ID等信息。

### 权限检查器
```bash
python check_permissions.py
```
检查机器人在各个服务器的权限配置是否正确。

### 测试运行器
```bash
python run_tests.py
```
运行完整的测试套件，检查代码质量和功能完整性。

## 🔍 故障排除

### 常见问题及解决方案

#### 1. 机器人无法启动
**可能原因**：
- Token错误或过期
- Python版本不兼容
- 依赖包缺失

**解决方案**：
```bash
# 检查Python版本
python --version

# 重新安装依赖
pip install -r requirements.txt --upgrade

# 验证配置
python config_validator.py
```

#### 2. 斜杠命令不显示
**可能原因**：
- 缺少 `applications.commands` 权限
- 应用命令同步延迟

**解决方案**：
1. 重新邀请机器人并确保勾选 `applications.commands` 权限
2. 等待几分钟让Discord同步命令

#### 3. 匿名反馈失败
**可能原因**：
- 目标频道权限不足
- 不是论坛频道的帖子
- 反馈功能未启用

**解决方案**：
1. 检查机器人在目标频道的权限
2. 确保是在论坛频道的帖子内使用
3. 在配置文件中启用匿名反馈功能

#### 4. 多服务器数据混乱
**可能原因**：
- 配置文件中服务器ID配置错误
- 权限配置错误

**解决方案**：
```bash
# 运行配置验证器
python config_validator.py

# 检查权限配置
python check_permissions.py
```

### 获取技术支持
1. **📖 查看文档**：详细阅读 [部署指南.md](部署指南.md)
2. **🔍 运行诊断**：使用 `python config_validator.py` 自动诊断
3. **📊 检查日志**：查看机器人日志频道的详细错误信息
4. **🚀 重新配置**：使用 `python 快速部署.py` 重新进行配置

##  贡献指南

### 开发环境设置
```bash
# 克隆项目
git clone <repository-url>
cd Odysseia-Main

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 安装开发依赖
pip install -r requirements.txt
pip install -r requirements-test.txt

# 运行测试
python run_tests.py
```

### 代码贡献流程
1. Fork 项目
2. 创建功能分支
3. 编写代码和测试
4. 提交 Pull Request

## 📄 许可证

本项目使用 MIT 与 Commons Clause 混合许可证。详情请查看 [LICENSE](LICENSE) 文件。

## 🙏 致谢

感谢所有贡献者和社区成员的支持，特别是：
- 原始 Odysseia Bot 项目的开发者
- Discord.py 库的维护者
- 所有提供反馈和建议的用户